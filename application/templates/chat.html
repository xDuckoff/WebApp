<html>
    <head>
        <title>SUPER CRAZY NAME</title>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
        <link rel="stylesheet" href="{{ url_for('static', filename='css/bootstrap.min.css') }}">
        <script src="{{ url_for('static', filename='js/jquery.min.js') }}" type="text/javascript"></script>


        <!-- CODEMIRROR -->
        <script src="{{ url_for('static', filename='js/codemirror/lib/codemirror.js') }}"></script>
        <link rel="stylesheet" href="{{ url_for('static', filename='js/codemirror/lib/codemirror.css') }}">
        <script src="{{ url_for('static', filename='js/codemirror/mode/javascript/javascript.js') }}"></script>
        <script src="{{ url_for('static', filename='js/codemirror/mode/python/python.js') }}"></script>

        <!--socketIO-->
        <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/socket.io/1.3.5/socket.io.min.js"></script>
        <script type="text/javascript" src="//code.jquery.com/jquery-2.1.4.min.js"></script>
        <script type="text/javascript" charset="utf-8">
            $(document).ready(function(){
                var socket = io.connect('http://' + document.domain + ':' + location.port);
                var chat_id = location.pathname.substr(location.pathname.lastIndexOf("/") + 1);
                socket.on('connect', function() {
                    get_messages();
                    socket.emit('join', chat_id);
                });
                socket.on('disconnect', function() {
                    socket.emit('leave', chat_id);
                });

                socket.on('message', function(data) {
                    add_message(data);
                });

                $("#send-btn").click(function() {
                    socket.emit('message', {'message':$("#message-input").val(), 'room':chat_id, 'type':'usr'});
                    $("#message-input").val('');
                });
            });
        </script>


        <script type="text/javascript">
            var last_index;
            var chat_index;
            function append_to_textarea(message) {
                var text =  '<div class="well well-sm" style="word-wrap: break-word;">' +"<b>" + message.author + '</b><br>'+ message.message + "</div>";
                $("#chat-panel").append(text);
                var text_to_play = message.author + ' сказал ' + message.message;
                if (message.type != 'other_message') {
                    voice.addText(text_to_play);
                }
            }
            var voice = {
                stack: [],
                currentIndex: -1,
                isBusy:false,
                play: function(){
                    console.log('Play');
                    voice.isBusy = true;
                    this.currentIndex += 1;
                    var url = 'https://tts.voicetech.yandex.net/generate?'+
                    'key=2308bf65-4316-45e9-bcec-0f9d86a7ab63'+
                    '&text='+encodeURI(this.stack[this.currentIndex])+
                    '&fornat=wav'+
                    '&lang=ru-RU'+
                    '&speaker=jane';

                    this.audio.src = url;
                    this.audio.load();
                },
                init: function() {
                    this.audio = document.getElementById('audio');

                    this.audio.onloadeddata = function(){
                        console.log('onloadeddata');
                        voice.audio.play();
                    };

                    this.audio.onended = function(){
                        console.log('onended');
                        voice.checkEnd();
                    };

                },
                checkEnd: function(){
                    console.log('checkEnd');
                    this.isBusy = false;
                    voice.checkPlay();
                },
                checkPlay: function (){
                    console.log('checkPlay');
                    if (!this.isBusy &&  this.stack.length != (this.currentIndex + 1) ){
                        voice.play();
                    }
                },
                addText: function(text){
                    console.log('addText');
                    this.stack.push(text);
                    this.checkPlay();

                }
            };


            function get_scrollHeight(element) {
                var pr = element.scrollTop();
                element.scrollTop(element.get(0).scrollHeight);
                var res = element.scrollTop();
                element.scrollTop(pr);
                return res;
            }
            function add_message(message) {
                var t = false;
                if (get_scrollHeight($('#chat-panel')) == $('#chat-panel').scrollTop())
                    t = true;
                append_to_textarea(message);
                if (t)
                    $('#chat-panel').scrollTop($('#chat-panel').get(0).scrollHeight);
            }

            function get_messages() {
                $.get( "/get_messages?chat="+chat_index, function( data ) {
                    var messages = $.parseJSON(data);
                    for (var i = 0; i < messages.length; i++) {
                        add_message(messages[i]);
                    }
                    last_index+=messages.length;
                });
            }

            jQuery(function ($) {
                voice.init();
                chat_index =  location.pathname.substr(location.pathname.lastIndexOf("/") + 1);
                $("#message-input").keypress(function(e) {
                    if(e.which == 13) {
                        $("#send-btn").click();
                    }
                });

                $('#code-editor').val("print('Hello World!')");
                var editor = CodeMirror.fromTextArea($('#code-editor').get(0), {
                    mode: {name: "python",
                           version: 2,
                           singleLineStringErrors: false},
                    lineNumbers: true,
                    indentUnit: 4,
                    matchBrackets: true,
                    value: "print('Hello World!')"
                });
            });
        </script>
    </head>
    <body style="width: 100%; height: 100%; background-color: #2f3e4e;" >
        <audio src="" id="audio">
        </audio>
        <audio src="" id="sys_audio">
        </audio>
        <div class="container-fluid">
            <div class="row" style="color: #ffffff;">
                <center>
                    NAME OF THIS SUPER CHAT
                </center>
            </div>
            <div class="row">
                <div class="col-md-6">
                    <div class="panel panel-default">
                        <div class="panel-body" id="chat-panel" style="min-height: 500; max-height: 500;overflow-y: scroll;">

                            <!-- <b>Author</b> <br>
                            <div class="well well-sm" style="word-wrap: break-word;">
                                Text
                            </div> -->
                        </div>
                    </div>

                    <!-- <div class="panel panel-default">
                        <div class="panel-body"> -->
                            <label for="message-input" class="sr-only">Message</label>
                            <div class="row">
                                <div class="col-sm-10" >
                                    <input type="text" class="form-control" id="message-input" placeholder="Write here">
                                </div>
                                <div class="col-sm-2" style="padding-left: 0;">
                                    <button type="submit" class="btn btn-default btn-block" id="send-btn">Send</button>
                                </div>
                            </div>
                    <!--    </div>
                    </div> -->
                </div>
                <div class="col-md-6" id="column">
                    <textarea class="form-control" id="code-editor" rows="3" style="resize: vertical; "></textarea>
                    <button type="submit" class="btn btn-default btn-block" id="go-btn" style="margin-top:10px; margin-right:16px">Commit</button>
                                        <div class="row">
                                            <div class="col-sm-6" id="column">
                                                <button type="submit" class="btn btn-default btn-block" id="go-btn" style="margin-top:10px">Перейти</button>
                                            </div>
                                            <div class="col-sm-6" id="column">
                                                <button type="submit" class="btn btn-default btn-block" id="compare-btn" style="margin-top:10px">Сравнить с</button>
                                            </div>
                                            
                                        </div>  
                </div>
            </div>
        </div>
    </body>
</html>