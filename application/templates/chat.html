<html>
	<head>
		<title>SUPER CRAZY NAME</title>
		<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
		<link rel="stylesheet" href="{{ url_for('static', filename='css/bootstrap.min.css') }}">
		<script src="{{ url_for('static', filename='js/jquery.min.js') }}" type="text/javascript"></script>


		<!-- CODEMIRROR -->
		<script src="{{ url_for('static', filename='js/codemirror/lib/codemirror.js') }}"></script>
		<link rel="stylesheet" href="{{ url_for('static', filename='js/codemirror/lib/codemirror.css') }}">
		<script src="{{ url_for('static', filename='js/codemirror/mode/javascript/javascript.js') }}"></script>
		<script src="{{ url_for('static', filename='js/codemirror/mode/python/python.js') }}"></script>

		<script type="text/javascript">
			var last_index;
			var chat_index;
			function append_to_textarea(message) {
				var text =  '<div class="well well-sm" style="word-wrap: break-word;">' +"<b>" + message.author + '</b><br>'+ message.message + "</div>";
				$("#chat-panel").append(text);
				//var text_to_tell = message.author + ' сказал ' + message.message;
				//if (message.type == 'other_message') {
				//	voice_messages(text_to_tell);
				//}
				//if (message.type == 'sys_message') {
				//	voice_sys_messages(text_to_tell);
				//}
			}

			//var voice_messages = function (text_to_tell){
            //    var audio = document. getElementById('audio');
            //    var url = 'https://tts.voicetech.yandex.net/generate?'+
            //    'key=2308bf65-4316-45e9-bcec-0f9d86a7ab63'+
            //    '&text='+encodeURI(text_to_tell)+
            //    '&fornat=wav'+
            //    '&lang=ru-RU'+
            //    '&speaker=jane';

             //   audio.src = url;
             //   audio.load();
             //   audio.onloadeddata = function(){
             //       audio.play();
              //  }
            //};

            voice = {
            	stack: [],
            	currentIndex: 0,
            	isBusy:false,
            	play: function(){
            		currentIndex += 1;
            		var audio = document. getElementById('audio');
					var url = 'https://tts.voicetech.yandex.net/generate?'+
					'key=2308bf65-4316-45e9-bcec-0f9d86a7ab63'+
					'&text='+encodeURI(stack[currentIndex])+
					'&fornat=wav'+
					'&lang=ru-RU'+
					'&speaker=jane';

					audio.src = url;
					audio.load();
					audio.onloadeddata = function(){
						audio.play();
					}
            	},
            	checkEnd: function(){
            		isBusy = false;
            	}
            	//проверка на то, что нужно ли озвучивать еще сообщения и поместить в CheckEnd
            }

            audio.onended = function(){
            	voice.checkEnd;
            }

			function get_scrollHeight(element) {
				var pr = element.scrollTop();
				element.scrollTop(element.get(0).scrollHeight);
				var res = element.scrollTop();
				element.scrollTop(pr);
				return res;
			}

			function add_message(message) {
				var t = false;
				if (get_scrollHeight($('#chat-panel')) == $('#chat-panel').scrollTop())
					t = true;
  				append_to_textarea(message);
  				if (t)
  					$('#chat-panel').scrollTop($('#chat-panel').get(0).scrollHeight);
			}

			function get_messages() {
				$.get( "/get_messages?chat="+chat_index + "&index=" + last_index, function( data ) {
					var messages = $.parseJSON(data);
					for (var i = 0; i < messages.length; i++) {
						add_message(messages[i]);
					}
					last_index+=messages.length;
				});
			}

			$(function () {
				last_index = 0;
				var timerId = setInterval(get_messages, 10000);
				chat_index =  location.pathname.substr(location.pathname.lastIndexOf("/") + 1);
				$("#send-btn").click(function() {
					//add_message("test_name", $("#message-input").val());
					$.get( "/send_message?chat="+chat_index + "&message=" + $("#message-input").val(), function( data ) {
					  //alert(data);
					});
					$("#message-input").val('');
					//get_messages();
				});

				$("#message-input").keypress(function(e) {
				    if(e.which == 13) {
				        $("#send-btn").click();
				    }
				});

				$('#code-editor').val("print('Hello World!')");
				var editor = CodeMirror.fromTextArea($('#code-editor').get(0), {
			        mode: {name: "python",
			               version: 2,
			               singleLineStringErrors: false},
			        lineNumbers: true,
			        indentUnit: 4,
			        matchBrackets: true,
			        value: "print('Hello World!')"
			    });

				get_messages();
				// var myCodeMirror = CodeMirror($('#column').get(0), {
				//   value: "print('Hello world!')\n",
				//   mode:  "python"
				// });

			});
		</script>
	</head>
	<body style="width: 100%; height: 100%; background-color: #2f3e4e;" >
        <audio src="" id="audio">
        </audio>
		<audio src="" id="sys_audio">
        </audio>
		<div class="container-fluid">
			<div class="row" style="color: #ffffff;">
				<center>
					NAME OF THIS SUPER CHAT
				</center>
			</div>
			<div class="row">
				<div class="col-md-6">
					<div class="panel panel-default">
						<div class="panel-body" id="chat-panel" style="min-height: 500; max-height: 500;overflow-y: scroll;">
							<!-- <b>Author</b> <br>
							<div class="well well-sm" style="word-wrap: break-word;">
								Text
							</div> -->
						</div>
					</div>
					
					<!-- <div class="panel panel-default">
						<div class="panel-body"> -->
							<label for="message-input" class="sr-only">Message</label>
							<div class="row">
								<div class="col-sm-10" >
			    					<input type="text" class="form-control" id="message-input" placeholder="Write here">
		    					</div>
		    					<div class="col-sm-2" style="padding-left: 0;">
									<button type="submit" class="btn btn-default btn-block" id="send-btn">Send</button>
								</div>
							</div>
					<!--	</div>
					</div> -->
				</div>
				<div class="col-md-6" id="column">
					<textarea class="form-control" id="code-editor" rows="3" style="resize: vertical; "></textarea>
				</div>
			</div>
		</div>
	</body>
</html>