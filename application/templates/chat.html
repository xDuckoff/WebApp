{% extends "base.html" %}

{% block title %}{{ chat_info["name"] }}{% endblock %}

{% block includes %}
<!--Treant-->
<link rel="stylesheet" href="{{ url_for('static', filename='css/Treant.css') }}" type="text/css"/>
<!-- CODEMIRROR -->
<link rel="stylesheet" href="{{ url_for('static', filename='js/codemirror/lib/codemirror.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='js/codemirror/addon/merge/merge.css') }}">
{% endblock %}

{% block content %}
<audio src="" id="audio"></audio>
<audio src="" id="sys_audio"></audio>
<div class="container-fluid">
    <div class="row">
        <h3 class="text-center" style="margin-top: -20px;">
             {{ chat_info["name"] }}
        </h3>
    </div>
    <div class="row">
        <div class="col-md-6">
            <div class="panel panel-default">
                <div class="panel-body" id="chat-panel">

                </div>
            </div>
            <label for="message-input" class="sr-only">Сообщение</label>
            <div class="row">
                <div class="col-sm-12">
                    <div class="input-group">
                        <input type="text" class="form-control" id="message-input" placeholder="Пиши здесь" maxlength="1000">
                        <div class="input-group-btn">
                                <button type="button" class="btn btn-primary btn-block" style="border-radius: 0px" id="send-btn">Отправить</button>
                        </div>
                        <span class="input-group-addon">
                            <input type="checkbox"  id="voice-check"> <image src="{{ url_for('static', filename='img/sound.png') }}" id="voice-img"></image>
                        </span>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-sm-12">
                    <strong>**жирный**</strong> <em>_курсив_</em> <code>`встроенный код`</code> <code>```форматированный```</code>
                </div>
            </div>
        </div>
        <div class="col-md-6" id="column">
            <textarea class="form-control" id="code-editor" rows="3"></textarea>
            <button type="submit" class="btn btn-default btn-block chat-control-btn" id="go-btn" data-toggle="modal" data-target="#send">Сохранить изменения</button>
            <div class="row">
                <div class="col-sm-12" id="column">
                    <div type="submit" class="btn btn-default btn-block chat-control-btn" id="compare-btn">Сравнить с исходным кодом</div>
                </div>
            </div>
            <div class="row">
                <div class="col-sm-12" id="tree"></div>
            </div>
        </div>
    </div>

    <div class="modal modal-wide fade" id="compare" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="main-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                    <h4 class="modal-title" id="myLabel" align=center>Сравнить с исходным кодом</h4>
                </div>
                <div class="modal-body">
                    <div rows="3" id="comp"></div>
                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-default" id="close-btn">Закрыть</button>
                </div>
            </div>
        </div>
    </div>
    <div class="modal fade" id="send" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
        <div class="modal-dialog" >
            <div class="main-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                    <p class="modal-title" id="myLabel">Отправка кода</p>
                </div>
                <div class="modal-body">
                        <input type="text" class="form-control" placeholder="Название коммита" id="to_send">
                </div>
                <div class="modal-footer">
                    <button type="s" class="btn btn-default" id="send-btn" data-dismiss="modal" onclick="send_code()">Отправить</button>
                    <button type="s" class="btn btn-default" id="send-btn" data-dismiss="modal" onclick="$('#to_send').val('');">Отмена</button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!--Treant-->
<script src="{{ url_for('static', filename='js/vendor/raphael.js') }}"></script>
<script src="{{ url_for('static', filename='js/Treant.js') }}"></script>

<!-- CODEMIRROR -->
<script src="{{ url_for('static', filename='js/codemirror/lib/codemirror.js') }}"></script>
<script src="{{ url_for('static', filename='js/diff_match_patch.js') }}"></script>
<script src="{{ url_for('static', filename='js/codemirror/addon/merge/merge.js') }}"></script>
<script src="{{ url_for('static', filename='js/codemirror/mode/xml/xml.js') }}"></script>
<script src="{{ url_for('static', filename='js/codemirror/mode/javascript/javascript.js') }}"></script>
<script src="{{ url_for('static', filename='js/codemirror/mode/python/python.js') }}"></script>
<script src="{{ url_for('static', filename='js/codemirror/mode/htmlmixed/htmlmixed.js') }}"></script>
<script src="{{ url_for('static', filename='js/codemirror/mode/css/css.js') }}"></script>
<script src="{{ url_for('static', filename='js/codemirror/mode/clike/clike.js') }}"></script>
    {% if socket_mode %}
<!--socketIO-->
<script src="{{ url_for('static', filename='js/socket.io.min.js') }}"></script>
    {% endif %}

<script type="text/javascript">
    var INTERVAL = 1000,
        RUS_IMAGE_ICON = '{{ url_for("static", filename="img/flag-rus.gif") }}',
        ENG_IMAGE_ICON = '{{ url_for("static", filename="img/flag-eng.gif") }}';
    var chat_index = {{ chat_id }},
        chat_code_type = "{{ chat_info['code_type'] }}",
        startCommit = {{ chat_info.start_code.id }},
        chosen_commit = 0;
    var parent_index = startCommit;
    $.ajaxSetup({
        headers: {
            'X-Csrf-Token': "{{ csrf_token() }}"
        }
    });
</script>

<script src="{{ url_for('static', filename='js/chat/voice.kit.js') }}"></script>
<script src="{{ url_for('static', filename='js/chat/notification.kit.js') }}"></script>
<script src="{{ url_for('static', filename='js/chat/messages.js') }}"></script>
<script src="{{ url_for('static', filename='js/chat/code.js') }}"></script>
<script src="{{ url_for('static', filename='js/chat/tree.js') }}"></script>
<script src="{{ url_for('static', filename='js/chat/compare_code.js') }}"></script>
    {% if socket_mode %}
<script src="{{ url_for('static', filename='js/chat/socket_events.js') }}"></script>
    {% endif %}
<script type="text/javascript">
    jQuery(function ($) {
    {% if not socket_mode %}
        joinToChat();
        get_messages(false);
        var timerId = setInterval(function (){
                    get_messages(true);
                    get_tree("tree");
                }, INTERVAL);
    {% endif %}
    {% if not socket_mode %}
        $("#send-btn").click(function() {
            $.ajax({
                url: "/send_message",
                data: {
                    "chat": chat_index,
                    "message" : $("#message-input").val()
                }
            });
            $("#message-input").val('');
        });
    {% endif %}
        $("#login-btn").click(function() {
            if (chat_id == '')
                window.location = "/login";
            else
                window.location = "/login?chat=" + chat_id;
        });

        $('#tree').on("click", ".commit_node", function(){
            var commitId = $(this).data('id');
            draw_node(commitId);
            get_code(commitId);
        });
    });


    function joinToChat(){
        $.ajax({
            type: "GET",
            url: "/add_chat",
            data: {
                chat: chat_index
            }
        });
    }
</script>

{% endblock %}
