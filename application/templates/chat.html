{% extends "base.html" %}

{% block title %}SUPER CRAZY NAME{% endblock %}

{% block includes %}
<!--Treant-->
<link rel="stylesheet" href="{{ url_for('static', filename='css/Treant.css') }}" type="text/css"/>
<script src="{{ url_for('static', filename='js/vendor/raphael.js') }}"></script>
<script src="{{ url_for('static', filename='js/Treant.js') }}"></script>
<script type="text/javascript" charset="utf-8">
    var chat_index = {{ chat_id }};
</script>
<!-- CODEMIRROR -->
<script src="{{ url_for('static', filename='js/codemirror/lib/codemirror.js') }}"></script>
<link rel="stylesheet" href="{{ url_for('static', filename='js/codemirror/lib/codemirror.css') }}">
<script src="{{ url_for('static', filename='js/codemirror/mode/javascript/javascript.js') }}"></script>
<script src="{{ url_for('static', filename='js/codemirror/mode/python/python.js') }}"></script>

{% if socket_mode %}
<!--socketIO-->
<script src="{{ url_for('static', filename='js/socket.io.min.js') }}"></script>
{% endif %}

{% endblock %}

{% block scripts %}

{% if socket_mode %}
<script type="text/javascript" charset="utf-8">
    jQuery(function ($) {
        var socket = io.connect('http://' + document.domain + ':' + location.port);
        socket.on('connect', function() {
            get_messages();
            socket.emit('join', chat_index);
        });
        socket.on('disconnect', function() {
            socket.emit('leave', chat_index);
        });

        socket.on('message', function(data) {
            add_message(data);
        });

        socket.on('commit', function() {
            get_tree("tree");
        });

        $.ajax({
            type: "GET",
            url: "/add_chat",
            data: {
                chat_id: chat_index
            }
        });

        $("#send-btn").click(function() {
            socket.emit('message', {'message':$("#message-input").val(), 'room':chat_index, 'type':'usr'});
            $("#message-input").val('');
        });
    });
</script>
{% endif %}

<script type="text/javascript">
    var last_index;
    
    function append_to_textarea(message) {
        if (message.author == "System"){
            var text =  '<div class="well well-sm text-center" id="system_message">' + "<b>" + message.author + '</b><br />'+ message.message +"</div>";
        }else{
            var text =  '<div class="well well-sm" id="user_message">' +"<b>" + message.author + '</b><br>'+ message.message + "</div>";
        }
        $("#chat-panel").append(text);
        if ($("#voice-check").prop("checked")){
            if (message.type != 'sys') {
                var text_to_play = message.author + ' сказал ' + message.message;
                voice.addText(text_to_play);
            } else {
                var text_to_play = message.message;
                voice.addText(text_to_play);
            }
        };
    };
    var voice = {
        stack: [],
        currentIndex: -1,
        isBusy:false,
        play: function(){
            console.log('Play');
            voice.isBusy = true;
            this.currentIndex += 1;
            var url = 'https://tts.voicetech.yandex.net/generate?'+
            'key=2308bf65-4316-45e9-bcec-0f9d86a7ab63'+
            '&text='+encodeURI(this.stack[this.currentIndex])+
            '&fornat=wav'+
            '&lang=ru-RU'+
            '&speaker=jane';

            this.audio.src = url;
            this.audio.load();
        },
        init: function() {
            this.audio = document.getElementById('audio');

            this.audio.onloadeddata = function(){
                console.log('onloadeddata');
                voice.audio.play();
            };

            this.audio.onended = function(){
                console.log('onended');
                voice.checkEnd();
            };

        },
        checkEnd: function(){
            console.log('checkEnd');
            this.isBusy = false;
            voice.checkPlay();
        },
        checkPlay: function (){
            console.log('checkPlay');
            if (!this.isBusy &&  this.stack.length != (this.currentIndex + 1) ){
                voice.play();
            }
        },
        addText: function(text){
            console.log('addText');
            this.stack.push(text);
            this.checkPlay();

        }
    };


    function get_scrollHeight(element) {
        var pr = element.scrollTop();
        element.scrollTop(element.get(0).scrollHeight);
        var res = element.scrollTop();
        element.scrollTop(pr);
        return res;
    }
    function add_message(message) {
        var t = false;

        if (get_scrollHeight($('#chat-panel')) == $('#chat-panel').scrollTop())
            t = true;
        append_to_textarea(message);
        if (t)
            $('#chat-panel').scrollTop($('#chat-panel').get(0).scrollHeight);
        if (("Notification" in window) && (Notification.permission === "granted")) {
            var notification = new Notification(message.author, {body:message.message});
            Notification.sound; 
        }
        else if (Notification.permission !== 'denied') {
            Notification.requestPermission(function (permission) {
                if (permission === "granted") {
                    var notification = new Notification(message.author, {body:message.message});
                    Notification.sound;
                }   
            });
            
        }
    }

    function get_messages() {
        $.ajax({
            url: "/get_messages",
            data: {
                "chat": chat_index
            },
            dataType: "json",
            success: function(data) {
                var messages = data;
                for (var i = last_index; i < messages.length; i++){
                    add_message(messages[i]);
                }
                last_index=messages.length;
            }
        });
    }

    jQuery(function ($) {
        voice.init();
        last_index = 0;
        {% if not socket_mode %}
        var timerId = setInterval(function (){
                    get_messages();
                    get_tree("tree");
                }, 5000);
        {% endif %}
        chat_index =  location.pathname.substr(location.pathname.lastIndexOf("/") + 1);
        $("#message-input").keypress(function(e) {
            if(e.which == 13) {
                $("#send-btn").click();
            }
        });
        editor = CodeMirror.fromTextArea($('#code-editor').get(0), {
            mode: {name: "python",
                   version: 2,
                   singleLineStringErrors: false},
            lineNumbers: true,
            indentUnit: 4,
            matchBrackets: true,
            value: "print('Hello World!')"
        });
        get_code(0);
        {% if not socket_mode %}
        $("#send-btn").click(function() {
            $.ajax({
                url: "/send_message",
                data: {
                    "chat": chat_index,
                    "message" : $("#message-input").val()
                }
            });
            $("#message-input").val('');
        });
        {% endif %}
        $("#login-btn").click(function() {
        if (chat_id == '') window.location = "/login";
        else window.location = "/login?chat=" + chat_id;
        });
    });

    function get_tree(objecy_id) {
        $.ajax({
            url:"/tree",
            type:"GET",
            data:{
                chat: chat_index
            },
            dataType: "html",
            success: function( data ) {
                $('#'+objecy_id).html(data);
            }
        });
    }
    function get_code(commit_index){
        code = ""
        $.ajax({
            url:"/get_code",
            type:"GET",
            data:{
                chat: chat_index,
                index: commit_index
            },
            dataType: "json",
            success: function(data){
                editor.getDoc().setValue(data.code);
            }
        });
    }
    get_tree("tree");
</script>

{% endblock %}

{% block content %}
<audio src="" id="audio">
</audio>
<audio src="" id="sys_audio">
</audio>
<div class="container-fluid">
    <div class="row">
        <p class="text-center"> 
        	{{ chat_info["name"] }}
        </p>
    </div>
    <div class="row">
        <div class="col-md-6">
            <div class="panel panel-default">
                <div class="panel-body" id="chat-panel">
                </div>
            </div>
            <label for="message-input" class="sr-only">Сообщение</label>
            <div class="row">
                <div class="col-sm-12">
                    <div class="input-group">
                        <input type="text" class="form-control" id="message-input" placeholder="Пиши здесь" maxlength="1000">
                        <div class="input-group-btn"> 
                                <button type="button" class="btn btn-default btn-block" id="send-btn">Отправить</button>
                        </div>
                        <span class="input-group-addon">
                            <input type="checkbox" id="voice-check"> Голос
                        </span>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-sm-12">
                    <strong>**жирный**</strong> <em>_курсив_</em> <code>`встроенный код`</code> <code>```форматированный```</code>
                </div>
            </div>
        </div>
        <div class="col-md-6" id="column">
            <textarea class="form-control" id="code-editor" rows="3"></textarea>
            <button type="submit" class="btn btn-default btn-block chat-control-btn" id="go-btn">Сохранить изменения</button>
            <div class="row">
                <div class="col-sm-12" id="tree"></div>
            </div>
            <div class="row">
                <div class="col-sm-6" id="column">
                    <button type="submit" class="btn btn-default btn-block chat-control-btn" id="go-btn">Перейти</button>
                </div>
                <div class="col-sm-6" id="column">
                    <button type="submit" class="btn btn-default btn-block chat-control-btn" data-toggle="modal" data-target="#compare" id="compare-btn" onclick="get_tree('tree');">Сравнить с</button>
                </div>
            </div>
        </div>
    </div>     
    <div class="modal fade" id="compare" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
        <div class="modal-dialog" >
            <div class="main-content">
                <form role = "form" action = "/create_chat">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                        <p class="modal-title" id="myLabel">Сравнить с</p>
                    </div>
                    <div class="modal-body">
                            <input type="text" class="form-control" placeholder="Commit">
                    </div>
                    <div class="modal-footer">
                        <button type="submit" class="btn btn-default" id="com-btn">Сравнить</button> 
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}
