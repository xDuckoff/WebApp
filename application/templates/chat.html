<html>
    <head>
        <title>SUPER CRAZY NAME</title>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
        <link rel="stylesheet" href="{{ url_for('static', filename='css/bootstrap.min.css') }}">
        <script src="{{ url_for('static', filename='js/jquery.min.js') }}" type="text/javascript"></script>
        <script src="{{ url_for('static', filename='js/bootstrap.min.js') }}" type="text/javascript"></script>

        <!--Treant-->
        <link rel="stylesheet" href="{{ url_for('static', filename='css/Treant.css') }}" type="text/css"/>
        <script src="{{ url_for('static', filename='js/vendor/raphael.js') }}"></script>
        <script src="{{ url_for('static', filename='js/Treant.js') }}"></script>

        <!-- CODEMIRROR -->
        <script src="{{ url_for('static', filename='js/codemirror/lib/codemirror.js') }}"></script>
        <link rel="stylesheet" href="{{ url_for('static', filename='js/codemirror/lib/codemirror.css') }}">
        <script src="{{ url_for('static', filename='js/codemirror/mode/javascript/javascript.js') }}"></script>
        <script src="{{ url_for('static', filename='js/codemirror/mode/python/python.js') }}"></script>

        <script type="text/javascript" charset="utf-8">
            var chat_index = {{ chat_id }};
        </script>

        {% if socket_mode %}
        <!--socketIO-->
        <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/socket.io/1.3.5/socket.io.min.js"></script>
        <script type="text/javascript" src="//code.jquery.com/jquery-2.1.4.min.js"></script>
        <script type="text/javascript" charset="utf-8">
        var chat_index = {{ chat_id }};
            jQuery(function ($) {
                var socket = io.connect('http://' + document.domain + ':' + location.port);
                socket.on('connect', function() {
                    get_messages();
                    socket.emit('join', chat_index);
                });
                socket.on('disconnect', function() {
                    socket.emit('leave', chat_index);
                });

                socket.on('message', function(data) {
                    add_message(data);
                });

                socket.on('commit', function() {
                    get_tree("tree");
                });

                $("#send-btn").click(function() {
                    socket.emit('message', {'message':$("#message-input").val(), 'room':chat_index, 'type':'usr'});
                    $("#message-input").val('');
                });
            });
        </script>
        {% endif %}


        <script type="text/javascript">
            var last_index;
            
            function append_to_textarea(message) {
                var text =  '<div class="well well-sm" style="word-wrap: break-word;">' +"<b>" + message.author + '</b><br>'+ message.message + "</div>";
                $("#chat-panel").append(text);
                if ($("#voice-check").prop("checked")){
                    if (message.type != 'sys') {
                        var text_to_play = message.author + ' сказал ' + message.message;
                        voice.addText(text_to_play);
                    } else {
                        var text_to_play = message.message;
                        voice.addText(text_to_play);
                    }
                };
            };
            var voice = {
                stack: [],
                currentIndex: -1,
                isBusy:false,
                play: function(){
                    console.log('Play');
                    voice.isBusy = true;
                    this.currentIndex += 1;
                    var url = 'https://tts.voicetech.yandex.net/generate?'+
                    'key=2308bf65-4316-45e9-bcec-0f9d86a7ab63'+
                    '&text='+encodeURI(this.stack[this.currentIndex])+
                    '&fornat=wav'+
                    '&lang=ru-RU'+
                    '&speaker=jane';

                    this.audio.src = url;
                    this.audio.load();
                },
                init: function() {
                    this.audio = document.getElementById('audio');

                    this.audio.onloadeddata = function(){
                        console.log('onloadeddata');
                        voice.audio.play();
                    };

                    this.audio.onended = function(){
                        console.log('onended');
                        voice.checkEnd();
                    };

                },
                checkEnd: function(){
                    console.log('checkEnd');
                    this.isBusy = false;
                    voice.checkPlay();
                },
                checkPlay: function (){
                    console.log('checkPlay');
                    if (!this.isBusy &&  this.stack.length != (this.currentIndex + 1) ){
                        voice.play();
                    }
                },
                addText: function(text){
                    console.log('addText');
                    this.stack.push(text);
                    this.checkPlay();

                }
            };


            function get_scrollHeight(element) {
                var pr = element.scrollTop();
                element.scrollTop(element.get(0).scrollHeight);
                var res = element.scrollTop();
                element.scrollTop(pr);
                return res;
            }
            function add_message(message) {
                var t = false;
                if (get_scrollHeight($('#chat-panel')) == $('#chat-panel').scrollTop())
                    t = true;
                append_to_textarea(message);
                if (t)
                    $('#chat-panel').scrollTop($('#chat-panel').get(0).scrollHeight);
            }

            function get_messages() {
                $.ajax({
                    url: "/get_messages",
                    data: {
                        "chat": chat_index
                    },
                    dataType: "json",
                    success: function(data) {
                        var messages = data;
                        for (var i = last_index; i < messages.length; i++){
                            add_message(messages[i]);
                        }
                        last_index=messages.length;
                    }
                });
            }

            
            function get_tree(objecy_id) {
                $.ajax({
                    url:"/tree",
                    type:"GET",
                    data:{
                        chat: chat_index
                    },
                    dataType: "html",
                    success: function( data ) {
                        $('#'+objecy_id).html(data);
                    }
                });
            }

            var editor;
            function get_code(commit_index){
                code = ""
                $.ajax({
                    url:"/get_code",
                    type:"GET",
                    data:{
                        chat: chat_index,
                        index: commit_index
                    },
                    dataType: "json",
                    success: function(data){
                        editor.getDoc().setValue(data.code);
                    }
                });
            }
            get_tree("tree");

            jQuery(function ($) {
                voice.init();
                last_index = 0;
                {% if not socket_mode %}
                var timerId = setInterval('get_messages(); get_tree("tree");', 5000);
                {% endif %}
                chat_index =  location.pathname.substr(location.pathname.lastIndexOf("/") + 1);
                $("#message-input").keypress(function(e) {
                    if(e.which == 13) {
                        $("#send-btn").click();
                    }
                });
                editor = CodeMirror.fromTextArea($('#code-editor').get(0), {
                    mode: {name: "python",
                           version: 2,
                           singleLineStringErrors: false},
                    lineNumbers: true,
                    indentUnit: 4,
                    matchBrackets: true,
                    value: "print('Hello World!')"
                });
                {% if not socket_mode %}
                $("#send-btn").click(function() {
                    $.ajax({
                        url: "/send_message",
                        data: {
                            "chat": chat_index,
                            "message" : $("#message-input").val()
                        }
                    });
                    $("#message-input").val('');
                });
                {% endif %}
                $("#login-btn").click(function() {
                if (chat_id == '') window.location = "/login";
                else window.location = "/login?chat=" + chat_id;
                });
            });
        </script>
    </head>
    <body style="width: 100%; height: 100%; background-color: #2f3e4e;" >

   <nav class="navbar navbar-inverse navbar-static-top" >
  <div class="container">
    
<li class="active">
    <a href="/">
        <button type="button" class="btn btn-primary navbar-btn">Главная</button>
        <span class="sr-only">(current)</span>
    </a>
    <a style = "padding-left: 20px">
        <button type="button" class="btn btn-primary navbar-btn" id="login-btn">Вход</button>
    </a>
</li>
    

  </div>
</nav>


        <audio src="" id="audio">
        </audio>
        <audio src="" id="sys_audio">
        </audio>
        <div class="container-fluid">
            <div class="row" style="color: #ffffff;">
                <center>
                    NAME OF THIS SUPER CHAT
                </center>
            </div>
	    
            <div class="row">
                <div class="col-md-6">
                    <div class="panel panel-default">
                        <div class="panel-body" id="chat-panel" style="min-height: 500; max-height: 500;overflow-y: scroll;">

                            <!-- <b>Author</b> <br>
                            <div class="well well-sm" style="word-wrap: break-word;">
                                Text
                            </div> -->
                        </div>
                    </div>

                    <!-- <div class="panel panel-default">
                        <div class="panel-body"> -->
                            <label for="message-input" class="sr-only">Message</label>
                            <div class="row">
                                <div class="col-sm-12">
                                    <div class="input-group">
                                        <input type="text" class="form-control" id="message-input" placeholder="Write here" maxlength="1000">
                                        <div class="input-group-btn"> 
                                                <button type="button" class="btn btn-default btn-block" id="send-btn">Send</button>
                                        </div>
                                        <span class="input-group-addon">
                                            <input type="checkbox" id="voice-check"> Voice
                                        </span>
                                    </div>
                                </div>
                            </div>
                    <!--    </div>
                    </div> -->
                </div>

                <div class="col-md-6" id="column">
                    <textarea class="form-control" id="code-editor" rows="3" style="resize: vertical; "></textarea>
                    <button type="submit" class="btn btn-default btn-block" id="go-btn" style="margin-top:10px; margin-right:16px">Commit</button>
                                        <div class="row">
                                        <div class="col-sm-12" id="tree"></div>
                                        </div>
                                        <div class="row">
                                            <div class="col-sm-6" id="column">
                                                <button type="submit" class="btn btn-default btn-block" id="go-btn" style="margin-top:10px">Перейти</button>
                                            </div>
                                            <div class="col-sm-6" id="column">
                                                <button type="submit" class="btn btn-default btn-block" data-toggle="modal" data-target="#compare" id="compare-btn" style="margin-top:10px" onclick="get_tree('tree');">Сравнить с</button>
                                            </div>
                                        </div>  
                </div>
        </div>
        <div class="modal fade" id="compare" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
						   	<div class="modal-dialog" >
								<div class="modal-content" style="border: 2px solid #424f5e; background: #1b2c3e; padding: 2%;">
									<form role = "form" action = "/create_chat">
										<div class="modal-header">
											<button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
											<center>
							        			<h4 class="modal-title" style="color: #dddddd" id="myLabel">Сравнить с</h4>
							      			</center>
							      		</div>
										<div class="modal-body">
											<centre>
												<input type="text" class="form-control" placeholder="Commit">
												<button type="submit" class="btn btn-default btn-block" id="com-btn" style="margin-top:20px">Сравнить</button> 
											</centre>
										</div>
									</form>
								</div>
							</div>
    </body>
</html>
